<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <title>Jogo de corrida</title>
        <style>
            #container {
                position: relative;
                width: 800px;
                height: 600px;
                margin: 0 auto;
                border: 1px solid #000;
                overflow: hidden;
                z-index: -1;
                background-color: white;
                
            }

            #carro {
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 50px;
                height: 50px;
                background-image: url('player.png');
                background-size: 100% 100%;
            
            }

            .obstaculo {
                position: absolute;
                width: 50px;
                height: 50px;

            }

            .obstaculo1 {
                background-image: url('car03.png');
                background-size: 100% 100%;
                background-color: transparent;
            
            }

            .obstaculo2 {
                background-color: red;
            }

            .obstaculo3 {
                background-color: blueviolet;
            }

            .obstaculo4 {
                background-color: blue;
            }

            #pontuacao {
                text-align: center;
                margin-top: 10px;
            }

            #barra-combustivel {
                width: 100%;
                height: 10px;
                background-color: #f00;
                margin-top: 10px;
            }

            #valor-pontuacao {
                font-weight: bold;
            }

            .poligono {
                position: absolute;
                width: 100%;
                height: 100%;
                z-index: -1;
                
            }

            /*Painel com as informações */
            #painel-informacoes {
                position: absolute;

                left: 0;
                right: 0;
                bottom: 0;

                width: 100%;
                height: 215px;

                display: flex;
                flex-direction: row;
                justify-content: space-between;

                margin: 0 auto;
            }

            #painel-informacoes #botao_de_iniciar,
            #painel-informacoes #painel {
                height: 200px;
                padding: 10px;

                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 10px;

                background-color: #0f8cf2;
            }

            #painel-informacoes #botao_de_iniciar {
                width: 20%;
                margin: 0 0 15px 10px;
            }

            #painel-informacoes #botao_de_iniciar #iniciar{
                text-align: center;
                padding: 10px;
                font-size: 18px;
                width: 100%;
                background-color: #ffab3d;
                cursor: pointer;
            }

            #painel-informacoes #painel {
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                flex-wrap: wrap;

                width: 20%;
                margin: 0 10px 15px 0;
            }

            #painel-informacoes #painel button {
                width: 125px;
                padding: 10px;
                font-size: 18px;
                cursor: pointer;
                background-color: #FFB73D;
            }

        </style>
    </head>
    <body>

        <div id="container">
            <div id="pontuacao">Pontuação: <span id="valor-pontuacao">0</span></div>
            <div id="barra-combustivel"></div>
            <div id="container-jogo"></div>
            <div id="carro"></div>
        </div>

        <!-- Painel contendo informações e botões (Isaac)-->
        <div id="painel-informacoes">
            <div id="botao_de_iniciar">
                <button id="iniciar">Inciar o jogo</button>
            </div>
        
            <div id="painel">
              <button id="dia">Dia</button>
              <button id="tarde">Tarde</button>
              <button id="noite">Noite</button>
              <button id="neve">Neve</button>
            </div>
        </div>

         <!-- Fim do Jogo!\n\nPontuação: ' + pontuacao + '\nRecargas de Combustível: ' + recargasCombustivel-->
        


        <script>
            // Variáveis globais
            var pontuacao = 0;
            var combustivel = 100;
            var intervaloCombustivel;
            var intervaloObstaculo;
            var velocidadeObstaculo = 2;
            var recargasCombustivel = 0;

            // Elementos do DOM
            var carro = document.getElementById('carro');
            var pontuacaoElemento = document.getElementById('valor-pontuacao');
            var barraCombustivel = document.getElementById('barra-combustivel');

            // Cenários disponíveis
            function dia(){
                var container = document.getElementById('container');
                container.style.backgroundColor = 'lightblue';
            }
            
            function tarde(){
                var container = document.getElementById('container');
                container.style.backgroundColor = 'orangered';
            }
            
            function noite(){
                var container = document.getElementById('container');
                container.style.backgroundColor = 'rgb(0, 0, 20)';
            }

            function neve(){
                var container = document.getElementById('container');
                container.style.backgroundColor = 'white';
            }

            // Mudanças no ambiente
            document.getElementById("dia").addEventListener("click", dia);
            document.getElementById("tarde").addEventListener("click", tarde);
            document.getElementById("noite").addEventListener("click", noite);
            document.getElementById("neve").addEventListener("click", neve);

            var direcaoCarro = 0; // -1 para a esquerda, 1 para a direita

            document.addEventListener('keydown', function (event) {
                if (event.key === 'ArrowLeft') {
                    direcaoCarro = -1;
                } else if (event.key === 'ArrowRight') {
                    direcaoCarro = 1;
                }
            });

            document.addEventListener('keyup', function (event) {
                if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                    direcaoCarro = 0; // Parar de mover quando a tecla for solta
                }
            });

            function moverCarro() {
                var posicaoEsquerda = parseInt(window.getComputedStyle(carro).getPropertyValue('left'));
                var novaPosicao = posicaoEsquerda + direcaoCarro * velocidadeObstaculo;

                if (novaPosicao >= 25 && novaPosicao <= 775) {
                    carro.style.left = novaPosicao + 'px';
                }
            }

            setInterval(moverCarro, 16); // Atualiza o movimento do carro a cada 16ms (aproximadamente 60 FPS)

            function criarObstaculo() {
                var tiposObstaculo = ['obstaculo1', 'obstaculo2', 'obstaculo3','obstaculo4']; // Tipos de obstáculos disponíveis
                var container = document.getElementById('container'); // Obtém o elemento container
             
                // Gera um número aleatório entre 0 e 99
                var probabilidade = Math.floor(Math.random() * 100);

                // Define o tipo de obstáculo com base na probabilidade
                var tipoObstaculo;
                if (probabilidade < 50) {
                    tipoObstaculo = 'obstaculo1';
                } else {
                    tipoObstaculo = tiposObstaculo[Math.floor(Math.random() * tiposObstaculo.length)];
                }

                // Cria a div do obstáculo(Rever)
                var obstaculo = document.createElement('div');
                obstaculo.className = 'obstaculo ' + tipoObstaculo;

                // Define a posição inicial do obstáculo no centro do container
                var posicaoInicialX = container.offsetWidth / 2 - 25;
                var posicaoInicialY = 325;

                obstaculo.style.left = posicaoInicialX + 'px';
                obstaculo.style.top = posicaoInicialY + 'px';

                // Adiciona o obstáculo ao container
                container.appendChild(obstaculo);

                // Define a posição atual do obstáculo
                var posicaoAtualX = posicaoInicialX;
                var posicaoAtualY = posicaoInicialY;
                var posicaoAleatoriaX = Math.floor(Math.random() * (600 - 150 + 1) + 150);
                var posicaoAleatoriaY = container.offsetHeight - obstaculo.offsetHeight;

                // Move o obstáculo diagonalmente em 60 FPS
                var intervalo = setInterval(function () {
                    // Calcula os deltas de movimento
                    var deltaX = posicaoAleatoriaX - posicaoAtualX;
                    var deltaY = posicaoAleatoriaY - posicaoAtualY;

                    // Calcula o vetor de movimento normalizado
                    var distancia = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    var vetorMovimento = {
                        x: deltaX / distancia,
                        y: deltaY / distancia,
                    };

                    // Atualiza a posição do obstáculo
                    posicaoAtualX += vetorMovimento.x * velocidadeObstaculo;
                    posicaoAtualY += vetorMovimento.y * velocidadeObstaculo;

                    // Verifica se ocorreu uma colisão
                    if (posicaoAtualY >= 546) {
                        clearInterval(intervalo); // Limpa o intervalo de movimento
                        verificarColisao(obstaculo, carro);
                        obstaculo.remove();
                        criarObstaculo();// Cria um novo obstáculo
                    } else {
                        obstaculo.style.left = posicaoAtualX + 'px';
                        obstaculo.style.top = posicaoAtualY + 'px';
                    }

                }, 1000 / 60); // 60 FPS
            }

            //verificar colisao
            function estaoSobrepostos(elementoA, elementoB) {
                const a = elementoA.getBoundingClientRect();
                const b = elementoB.getBoundingClientRect();
                const horizontal = a.left + a.width >= b.left && b.left + b.width >= a.left;
                const vertical = a.top + a.height >= b.top && b.top + b.height >= a.top;

                return horizontal && vertical;
            }

            function colidiu(carro, obstaculo) {
                return estaoSobrepostos(carro, obstaculo);
            }

            function verificarColisao(obstaculo) {
                var colidiuObstaculo = colidiu(carro, obstaculo);

                if (colidiuObstaculo) {
                    if (obstaculo.classList.contains('obstaculo1')) {//CARRO INIMIGO

                        encerrarJogo();
                        obstaculo.remove();
                        

                    } else if (obstaculo.classList.contains('obstaculo2')) {//ABASTECE A GASOLINA
                        pontuacao += 1;
                        pontuacaoElemento.textContent = pontuacao;
                        combustivel += 10;
                        if (combustivel > 100) {
                            combustivel = 100
                        }
                        barraCombustivel.style.width = combustivel + '%';
                        recargasCombustivel++;
                        //gerarObstaculo();
                        obstaculo.remove();
                    } else if (obstaculo.classList.contains('obstaculo3')) {//REDUZ A VELOCIDADE E PERDE PONTOS
                        if (pontuacao > 1) {
                            pontuacao -= 2;
                        }else{
                            pontuacao = 0;
                        }
                        pontuacaoElemento.textContent = pontuacao;
                        if (velocidadeObstaculo > 1) {
                            velocidadeObstaculo -= velocidadeObstaculo * 0.15;
                        }
                        //gerarObstaculo();
                        obstaculo.remove();
                    } else if (obstaculo.classList.contains('obstaculo4')) {//AUMENTA A VELOCIDADE E GANHA PONTO
                        pontuacao += 2;
                        pontuacaoElemento.textContent = pontuacao;
                        velocidadeObstaculo += 1;
                        //gerarObstaculo();
                        obstaculo.remove();
                    } else {
                        //gerarObstaculo();
                        obstaculo.remove();
                        pontuacao += 1;
                        pontuacaoElemento.textContent = pontuacao;
                    }

                } else if (obstaculo.style.top > '546px' && obstaculo.classList.contains('obstaculo1')) {
                    pontuacao += 1;
                    pontuacaoElemento.textContent = pontuacao;
                    obstaculo.remove();
                    criarObstaculo();
                }

            }

            // Controle de combustível
            function atualizarCombustivel() {
                combustivel -= 1;
                barraCombustivel.style.width = combustivel + '%';
                if (combustivel <= 0) {
                    encerrarJogo();
                }
            }

            // Fim do jogo
            function encerrarJogo() {
                clearInterval(intervaloCombustivel);
                clearInterval(intervaloObstaculo);

                alert('Fim do Jogo!\n\nPontuação: ' + pontuacao + '\nRecargas de Combustível: ' + recargasCombustivel);
            }

            //poligonos
            function criarPoligono(cor, x1, y1, x2, y2, x3, y3, x4, y4) {
                var container = document.getElementById('container');
                var poligono = document.createElement('div');
                var pontos = `${x1}px ${y1}px, ${x2}px ${y2}px, ${x3}px ${y3}px, ${x4}px ${y4}px`;
                poligono.style.clipPath = `polygon(${pontos})`;
                poligono.style.backgroundColor = cor;
                poligono.classList.add('poligono');
                container.appendChild(poligono);
            }

            function criaTrapezio(x1, y1, w1, x2, y2, w2, color = "green") {
                criarPoligono(
                    color,
                    x1 - w1, y1,
                    x1 + w1, y1,
                    x2 + w2, y2,
                    x2 - w2, y2
                );
            }

            //Cria grama e estrada
            function criaGrama(bol = false) {
                let w = 150;// distancia do segmento pro outro
                let x = 600; // tamanho da tela altura
                let y = x - w;
                let z = y - w / 2;
                let a = 300;//pista
                let b = 350;//borda
                var c = 0; //curva

                let verdeClaro = 'rgb(21, 97, 19)';
                let verdeEscuro = 'rgb(17, 77, 15)';
                let cinzaEscuro = 'rgb(83, 83, 83)';
                let cinzaclaro = 'rgb(126, 126, 126)';

                for (let i = 0; i < 4; i++) {

                    criaTrapezio(400, x, 400, 400, y, 400, bol ? verdeClaro : verdeEscuro);
                    criaTrapezio(400, y, 400, 400, z, 400, bol ? verdeEscuro : verdeClaro);
                    criaTrapezio(400 - c, x, b, 400 - c * 2, y, b / 2, bol ? 'black' : 'white');
                    criaTrapezio(400 - c * 2, y, b / 2, 400 - c * 3, z, b / 2 / 2, bol ? 'white' : 'black');
                    criaTrapezio(400 - c, x, a, 400 - c * 2, y, a / 2, bol ? cinzaEscuro : cinzaclaro);
                    criaTrapezio(400 - c * 2, y, a / 2, 400 - c * 3, z, a / 2 / 2, bol ? cinzaclaro : cinzaEscuro);

                    c = c * 3;
                    a = a / 2 / 2;
                    b = b / 2 / 2;

                    x = z;
                    w = w / 4;
                    y = x - w;
                    z = y - w / 2;

                }
            }

            //Muda a grama para dar a sensação de movimento
            function alternarChamadas() {
                let alternar = true;

                setInterval(function () {
                    if (alternar) {
                        criaGrama(true);
                    } else {
                        criaGrama(false);
                    }

                    alternar = !alternar;
                }, 1000/velocidadeObstaculo);
            }

            criaGrama();
            
            // Iniciar o jogo
            function iniciarJogo() {

                //removendo o div
                botao_de_iniciar.parentNode.removeChild(botao_de_iniciar);
                painel.parentNode.removeChild(painel);

                alternarChamadas();

                criarObstaculo();

                setInterval(function () {
                    atualizarCombustivel();
                }, 1000);
            }

            //iniciarJogo();
            document.getElementById("iniciar").addEventListener("click", iniciarJogo);


        </script>

    </body>
</html>